<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>AR 3D Chemistry Lab</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #000; }
        
        #status-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            z-index: 100;
            pointer-events: none;
        }

        .status-bar {
            background: rgba(0, 15, 30, 0.9);
            backdrop-filter: blur(15px);
            border-bottom: 3px solid #00f2fe;
            border-radius: 0 0 15px 15px;
            padding: 15px 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
        }

        h2 { margin: 0; font-size: 12px; color: #00f2fe; text-transform: uppercase; letter-spacing: 2px; }
        p { margin: 8px 0 0 0; font-size: 16px; color: #ffffff; font-weight: 600; }

        #action-container {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }

        button {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            border: none;
            padding: 18px 45px;
            border-radius: 50px;
            color: #0a192f;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 10px 25px rgba(0, 242, 254, 0.4);
            pointer-events: auto;
        }

        button:hover { transform: scale(1.05); box-shadow: 0 15px 35px rgba(0, 242, 254, 0.6); }
        button:disabled { background: #333; color: #777; cursor: not-allowed; box-shadow: none; }
    </style>
</head>
<body>

    <div id="status-container">
        <div class="status-bar">
            <h2 id="step-title">Phòng Thí Nghiệm 3D Thực Tế Ảo</h2>
            <p id="status-text">Đang đợi nhận diện thẻ Hiro...</p>
        </div>
    </div>

    <div id="action-container">
        <button id="main-btn" onclick="handleAction()">Bắt đầu thí nghiệm</button>
    </div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false;" 
        renderer="antialias: true; colorManagement: true; exposure: 1.1;"
        vr-mode-ui="enabled: false">

        <a-assets>
            <!-- Thủy tinh dày 3D -->
            <a-mixin id="glass-thick" material="color: #ffffff; opacity: 0.25; transparent: true; metalness: 0.9; roughness: 0.05; side: double; reflectivity: 1"></a-mixin>
            <!-- Hóa chất đậm đặc -->
            <a-mixin id="liquid-iodine" material="color: #4a1c00; opacity: 1; metalness: 0.2; roughness: 0.3"></a-mixin>
            <a-mixin id="water-hot" material="color: #ff3300; opacity: 0.4; transparent: true"></a-mixin>
            <a-mixin id="water-cold" material="color: #0066ff; opacity: 0.4; transparent: true"></a-mixin>
        </a-assets>

        <a-marker preset="hiro" id="marker">
            <a-entity id="zoom-rig" scale="1 1 1">
                <a-entity id="rig">
                    
                    <!-- 1. ỐNG NGHIỆM HÌNH TRỤ CHUẨN (Starch) -->
                    <a-entity id="test-tube-container" position="0 1.2 0.5">
                        <a-entity id="tube-body">
                            <!-- Thân thủy tinh -->
                            <a-cylinder height="3.0" radius="0.25" mixin="glass-thick" open-ended="false"></a-cylinder>
                            <!-- Vành miệng ống nghiệm -->
                            <a-torus radius="0.25" radius-tubular="0.02" rotation="90 0 0" position="0 1.5 0" mixin="glass-thick"></a-torus>
                            <!-- Đáy ống nghiệm (nửa hình cầu) -->
                            <a-sphere position="0 -1.5 0" radius="0.25" theta-length="90" rotation="180 0 0" mixin="glass-thick"></a-sphere>
                            
                            <!-- Hóa chất bên trong (Hồ tinh bột - ban đầu trong suốt đục nhẹ) -->
                            <a-entity id="liquid-group">
                                <a-cylinder id="liquid" height="0.01" radius="0.24" position="0 -1.5 0" material="color: #ffffff; opacity: 0.1; transparent: true"></a-cylinder>
                                <a-circle id="liquid-surface" radius="0.24" position="0 -1.5 0" rotation="-90 0 0" material="color: #ffffff; opacity: 0.1; transparent: true"></a-circle>
                            </a-entity>
                        </a-entity>
                        <a-text value="Ho tinh bot" position="0 2 0" align="center" width="3" color="#fff"></a-text>
                    </a-entity>

                    <!-- 2. LỌ IODINE HÌNH TRỤ & PIPETTE -->
                    <a-entity id="iodine-system" position="1.8 0.6 0.5">
                        <!-- Bình đựng Iodine -->
                        <a-cylinder height="1.2" radius="0.4" mixin="glass-thick"></a-cylinder>
                        <a-cylinder height="0.1" radius="0.4" position="0 -0.6 0" mixin="glass-thick"></a-cylinder> <!-- Đáy bình -->
                        <a-cylinder height="1.0" radius="0.38" position="0 -0.1 0" mixin="liquid-iodine"></a-cylinder> <!-- Iodine đậm đặc -->
                        
                        <!-- Pipette (Ống hút) -->
                        <a-entity id="pipette" position="0 1.2 0" rotation="0 0 -15">
                            <a-sphere radius="0.12" scale="1 1.5 1" position="0 0.8 0" material="color: #cc0000"></a-sphere>
                            <a-cylinder height="1.8" radius="0.02" mixin="glass-thick"></a-cylinder>
                            <a-cylinder id="pipette-liquid" height="0.5" radius="0.018" position="0 -0.4 0" mixin="liquid-iodine"></a-cylinder>
                            <a-cone height="0.2" radius-bottom="0.02" radius-top="0.005" position="0 -1.0 0" mixin="glass-thick"></a-cone>
                        </a-entity>
                        <a-text value="Iodine" position="0 1.5 0" align="center" width="3" color="#ffaa00"></a-text>
                    </a-entity>

                    <!-- 3. CỐC NƯỚC NÓNG (Beaker 3D) -->
                    <a-entity id="hot-beaker" position="-1.8 0.8 0.5">
                        <!-- Thân cốc -->
                        <a-cylinder height="2.0" radius="0.8" mixin="glass-thick" open-ended="true"></a-cylinder>
                        <!-- Đáy cốc dày -->
                        <a-cylinder height="0.1" radius="0.8" position="0 -1.0 0" mixin="glass-thick"></a-cylinder>
                        <!-- Vành cốc -->
                        <a-torus radius="0.8" radius-tubular="0.02" rotation="90 0 0" position="0 1.0 0" mixin="glass-thick"></a-torus>
                        <!-- Nước nóng màu đậm -->
                        <a-cylinder height="1.4" radius="0.78" position="0 -0.3 0" mixin="water-hot"></a-cylinder>
                        <a-text value="Nuoc Nong" position="0 1.5 0.5" align="center" width="3" color="#ff3300"></a-text>
                    </a-entity>

                    <!-- 4. CỐC NƯỚC LẠNH (Beaker 3D) -->
                    <a-entity id="cold-beaker" position="-3.8 0.8 0.5">
                        <a-cylinder height="2.0" radius="0.8" mixin="glass-thick" open-ended="true"></a-cylinder>
                        <a-cylinder height="0.1" radius="0.8" position="0 -1.0 0" mixin="glass-thick"></a-cylinder>
                        <a-torus radius="0.8" radius-tubular="0.02" rotation="90 0 0" position="0 1.0 0" mixin="glass-thick"></a-torus>
                        <!-- Nước lạnh màu đậm -->
                        <a-cylinder height="1.4" radius="0.78" position="0 -0.3 0" mixin="water-cold"></a-cylinder>
                        <a-text value="Nuoc Lanh" position="0 1.5 0.5" align="center" width="3" color="#0066ff"></a-text>
                    </a-entity>

                    <a-sphere id="iodine-drop" radius="0.04" material="color: #4a1c00" visible="false"></a-sphere>

                    <!-- Ánh sáng -->
                    <a-entity light="type: ambient; intensity: 0.6"></a-entity>
                    <a-entity light="type: directional; intensity: 1.0" position="1 4 3"></a-entity>
                </a-entity>
            </a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const marker = document.querySelector('#marker');
        const rig = document.querySelector('#rig');
        const liquid = document.querySelector('#liquid');
        const liquidSurface = document.querySelector('#liquid-surface');
        const pipette = document.querySelector('#pipette');
        const testTubeContainer = document.querySelector('#test-tube-container');
        const statusText = document.querySelector('#status-text');
        const mainBtn = document.querySelector('#main-btn');

        let currentStep = 0;
        let userRotationY = 0;

        // Màu sắc đúng bản chất
        const COLOR_STARCH_CLEAR = "#ffffff";
        const COLOR_IODINE_DEEP = "#4a1c00"; 
        const COLOR_COMPLEX_DEEP = "#000033"; // Xanh tím cực đậm (gần đen)

        function autoLeveling() {
            if (marker.object3D.visible) {
                const markerRotation = marker.object3D.rotation;
                rig.object3D.rotation.x = -markerRotation.x;
                rig.object3D.rotation.z = -markerRotation.z;
                rig.object3D.rotation.y = userRotationY;
            }
            requestAnimationFrame(autoLeveling);
        }
        autoLeveling();

        async function handleAction() {
            mainBtn.disabled = true;

            if (currentStep === 0) {
                statusText.textContent = "Đang chuẩn bị hồ tinh bột trong suốt...";
                liquid.setAttribute('animation', { property: 'height', to: 1.2, dur: 2000 });
                liquid.setAttribute('animation__pos', { property: 'position', to: '0 -0.9 0', dur: 2000 });
                liquidSurface.setAttribute('animation', { property: 'position', to: '0 -0.3 0', dur: 2000 });
                
                await new Promise(r => setTimeout(r, 2200));
                statusText.textContent = "Đã có hồ tinh bột. Hãy nhỏ Iodine.";
                mainBtn.textContent = "Nhỏ Iodine";
                currentStep = 1;
            } 
            else if (currentStep === 1) {
                statusText.textContent = "Nhỏ Iodine nâu đậm vào ống nghiệm...";
                pipette.setAttribute('animation', { property: 'position', to: '-1.8 1.5 0', dur: 1000 });
                pipette.setAttribute('animation__2', { property: 'rotation', to: '0 0 0', dur: 800 });
                
                await new Promise(r => setTimeout(r, 1100));
                const drop = document.querySelector('#iodine-drop');
                drop.setAttribute('visible', 'true');
                drop.setAttribute('position', '0 1.3 0.5');
                drop.setAttribute('animation', { property: 'position', to: '0 0.5 0.5', dur: 600 });
                
                await new Promise(r => setTimeout(r, 650));
                drop.setAttribute('visible', 'false');
                
                // Chuyển màu đậm đặc
                liquid.setAttribute('material', { color: COLOR_COMPLEX_DEEP, opacity: 1 });
                liquidSurface.setAttribute('material', { color: COLOR_COMPLEX_DEEP, opacity: 1 });
                
                await new Promise(r => setTimeout(r, 1000));
                statusText.textContent = "Phức xanh tím cực đậm đã hình thành.";
                mainBtn.textContent = "Nhúng Nước Nóng";
                currentStep = 2;
            }
            else if (currentStep === 2) {
                statusText.textContent = "Đang nhúng ống nghiệm vào cốc nước nóng...";
                
                // Nhấc lên và di chuyển đến cốc nóng (-1.8)
                testTubeContainer.setAttribute('animation', { property: 'position', to: '-1.8 3.0 0.5', dur: 1000 });
                await new Promise(r => setTimeout(r, 1100));
                
                // Nhúng xuống: cao độ cốc là 0.8, cốc cao 2.0. Nhúng sao cho hóa chất chìm.
                // Vị trí y = 0.5 sẽ làm phần đáy ống nghiệm ngập sâu trong nước cốc
                testTubeContainer.setAttribute('animation', { property: 'position', to: '-1.8 0.5 0.5', dur: 800 });
                await new Promise(r => setTimeout(r, 1000));
                
                // Mất màu (trong suốt trở lại)
                liquid.setAttribute('animation', { property: 'material.color', to: COLOR_STARCH_CLEAR, dur: 4000 });
                liquid.setAttribute('animation__op', { property: 'material.opacity', to: 0.1, dur: 4000 });
                liquidSurface.setAttribute('animation', { property: 'material.color', to: COLOR_STARCH_CLEAR, dur: 4000 });
                liquidSurface.setAttribute('animation__op', { property: 'material.opacity', to: 0.1, dur: 4000 });
                
                await new Promise(r => setTimeout(r, 4200));
                statusText.textContent = "Dung dịch mất màu khi nóng.";
                mainBtn.textContent = "Nhúng Nước Lạnh";
                currentStep = 3;
            }
            else if (currentStep === 3) {
                statusText.textContent = "Đang chuyển sang cốc nước lạnh...";
                
                testTubeContainer.setAttribute('animation', { property: 'position', to: '-1.8 3.0 0.5', dur: 800 });
                await new Promise(r => setTimeout(r, 900));
                
                testTubeContainer.setAttribute('animation', { property: 'position', to: '-3.8 3.0 0.5', dur: 1000 });
                await new Promise(r => setTimeout(r, 1100));
                
                testTubeContainer.setAttribute('animation', { property: 'position', to: '-3.8 0.5 0.5', dur: 800 });
                await new Promise(r => setTimeout(r, 1000));
                
                // Hiện màu đậm trở lại
                liquid.setAttribute('animation', { property: 'material.color', to: COLOR_COMPLEX_DEEP, dur: 3000 });
                liquid.setAttribute('animation__op', { property: 'material.opacity', to: 1, dur: 3000 });
                liquidSurface.setAttribute('animation', { property: 'material.color', to: COLOR_COMPLEX_DEEP, dur: 3000 });
                liquidSurface.setAttribute('animation__op', { property: 'material.opacity', to: 1, dur: 3000 });
                
                await new Promise(r => setTimeout(r, 3200));
                statusText.textContent = "Màu xanh tím đậm đã quay trở lại.";
                mainBtn.textContent = "Làm lại";
                currentStep = 4;
            } else {
                location.reload();
            }

            mainBtn.disabled = false;
        }

        marker.addEventListener('markerFound', () => { 
            statusText.textContent = "Đã thấy thẻ Hiro. Nhấn 'Bắt đầu'!"; 
        });
    </script>
</body>
</html>
