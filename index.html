<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>AR Floating Lab - Há»“ Tinh Bá»™t & Iodine</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Glassmorphism UI */
        #ui-layer {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            max-width: 450px;
            z-index: 100;
            pointer-events: none;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            pointer-events: auto;
        }

        h2 { margin: 0 0 10px 0; font-size: 18px; color: #00f2fe; text-transform: uppercase; letter-spacing: 2px; }
        p { margin: 0 0 15px 0; font-size: 14px; color: #fff; line-height: 1.4; }

        .btn-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

        button {
            background: linear-gradient(45deg, #00f2fe 0%, #4facfe 100%);
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            font-size: 12px;
            box-shadow: 0 4px 15px rgba(0, 242, 254, 0.3);
        }

        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 242, 254, 0.5); }
        button:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; }

        #guide {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 11px;
            pointer-events: none;
            border-left: 3px solid #00f2fe;
        }
    </style>
</head>
<body>

    <div id="guide">
        ðŸ’¡ HÆ°á»›ng dáº«n:<br>
        - QuÃ©t tháº» Hiro Ä‘á»ƒ hiá»ƒn thá»‹<br>
        - Vuá»‘t Ä‘á»ƒ xoay váº­t thá»ƒ<br>
        - Chá»¥m ngÃ³n tay Ä‘á»ƒ phÃ³ng to
    </div>

    <div id="ui-layer">
        <div class="glass-panel">
            <h2 id="step-title">ThÃ­ nghiá»‡m Há»“ Tinh Bá»™t</h2>
            <p id="status-text">HÆ°á»›ng camera vÃ o marker HIRO Ä‘á»ƒ báº¯t Ä‘áº§u.</p>
            <div class="btn-container">
                <button id="main-btn" onclick="handleAction()">Báº¯t Ä‘áº§u</button>
            </div>
        </div>
    </div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false;" 
        renderer="antialias: true; colorManagement: true;"
        vr-mode-ui="enabled: false">

        <a-assets>
            <a-mixin id="glass-mat" material="color: #ffffff; opacity: 0.15; transparent: true; metalness: 1; roughness: 0; side: double"></a-mixin>
            <a-mixin id="tech-ring" geometry="primitive: ring; radiusInner: 0.45; radiusOuter: 0.5" material="color: #00f2fe; emissive: #00f2fe; shader: flat; opacity: 0.8" animation="property: opacity; from: 0.8; to: 0.2; dur: 1000; dir: alternate; loop: true"></a-mixin>
        </a-assets>

        <a-marker preset="hiro" id="marker">
            <!-- Rig Ä‘iá»u khiá»ƒn Rotation vÃ  Zoom -->
            <a-entity id="rig" position="0 0 0" scale="1 1 1">
                
                <!-- PHÃ’NG THÃ NGHIá»†M KHÃ”NG TRá»ŒNG Lá»°C -->
                
                <!-- 1. á»ng nghiá»‡m chÃ­nh (LÆ¡ lá»­ng trung tÃ¢m) -->
                <a-entity id="test-tube-container" position="0 1.5 0">
                    <!-- VÃ²ng trÃ²n cÃ´ng nghá»‡ dÆ°á»›i á»‘ng nghiá»‡m -->
                    <a-entity mixin="tech-ring" rotation="-90 0 0" position="0 -2.2 0"></a-entity>
                    
                    <a-entity id="tube-body">
                        <a-cylinder height="4" radius="0.4" mixin="glass-mat"></a-cylinder>
                        <a-sphere position="0 -2 0" radius="0.4" theta-length="90" rotation="180 0 0" mixin="glass-mat"></a-sphere>
                        <a-torus position="0 2 0" radius="0.4" radius-tubular="0.02" rotation="90 0 0" mixin="glass-mat"></a-torus>
                        
                        <!-- Dung dá»‹ch bÃªn trong -->
                        <a-entity id="liquid-group">
                            <a-cylinder id="liquid" height="1.8" radius="0.38" position="0 -1.1 0" material="color: #ffffff; opacity: 0.8; transparent: true"></a-cylinder>
                            <a-circle id="liquid-surface" radius="0.38" position="0 -0.2 0" rotation="-90 0 0" material="color: #ffffff; opacity: 0.9"></a-circle>
                        </a-entity>
                    </a-entity>
                </a-entity>

                <!-- 2. Pipette (LÆ¡ lá»­ng bÃªn pháº£i) -->
                <a-entity id="pipette" position="1.5 2.5 0" rotation="0 0 -30">
                    <a-sphere radius="0.15" scale="1 1.5 1" position="0 1.2 0" material="color: #333; roughness: 0.8"></a-sphere> <!-- Báº§u cao su -->
                    <a-cylinder height="2.5" radius="0.03" position="0 -0.1 0" mixin="glass-mat"></a-cylinder> <!-- ThÃ¢n thá»§y tinh -->
                    <a-cylinder id="pipette-liquid" height="0.8" radius="0.02" position="0 -0.6 0" material="color: #8b4513; opacity: 0.9"></a-cylinder> <!-- Iodine -->
                    <a-cone height="0.4" radius-bottom="0.03" radius-top="0.005" position="0 -1.5 0" mixin="glass-mat"></a-cone>
                </a-entity>

                <!-- 3. Cá»‘c Thá»§y Tinh (NÆ°á»›c NÃ³ng/Láº¡nh - sáº½ xuáº¥t hiá»‡n khi cáº§n) -->
                <a-entity id="beaker" position="-1.8 1.5 0" visible="false">
                    <a-entity mixin="tech-ring" rotation="-90 0 0" position="0 -1.2 0" material="color: #ff4b2b"></a-entity>
                    <a-cylinder height="2.5" radius="0.8" mixin="glass-mat" open-ended="true"></a-cylinder>
                    <a-cylinder height="0.1" radius="0.8" position="0 -1.25 0" mixin="glass-mat"></a-cylinder>
                    <a-cylinder id="beaker-liquid" height="1.8" radius="0.78" position="0 -0.3 0" material="color: #4facfe; opacity: 0.4; transparent: true"></a-cylinder>
                    <a-text id="beaker-label" value="NÆ¯á»šC NÃ“NG" align="center" position="0 1.5 0" color="#fff" width="4"></a-text>
                </a-entity>

                <!-- Giá»t rÆ¡i -->
                <a-sphere id="iodine-drop" radius="0.04" material="color: #8b4513" visible="false"></a-sphere>

                <!-- Ãnh sÃ¡ng -->
                <a-entity light="type: ambient; intensity: 0.6"></a-entity>
                <a-entity light="type: point; intensity: 0.8; distance: 10" position="0 4 2"></a-entity>
            </a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const marker = document.querySelector('#marker');
        const rig = document.querySelector('#rig');
        const liquid = document.querySelector('#liquid');
        const liquidSurface = document.querySelector('#liquid-surface');
        const pipette = document.querySelector('#pipette');
        const beaker = document.querySelector('#beaker');
        const beakerLiquid = document.querySelector('#beaker-liquid');
        const beakerLabel = document.querySelector('#beaker-label');
        const statusText = document.querySelector('#status-text');
        const mainBtn = document.querySelector('#main-btn');

        let currentStep = 0;
        let userRotationY = 0;
        let userScale = 1;

        // --- Há»† THá»NG AUTO-LEVELING (TRIá»†T TIÃŠU X VÃ€ Z) ---
        function autoLeveling() {
            if (marker.object3D.visible) {
                // Láº¥y gÃ³c xoay hiá»‡n táº¡i cá»§a marker
                const markerRotation = marker.object3D.rotation;
                
                // Triá»‡t tiÃªu X vÃ  Z báº±ng cÃ¡ch gÃ¡n giÃ¡ trá»‹ ngÆ°á»£c láº¡i cho rig
                // Chá»‰ giá»¯ láº¡i Rotation Y do ngÆ°á»i dÃ¹ng Ä‘iá»u khiá»ƒn
                rig.object3D.rotation.x = -markerRotation.x;
                rig.object3D.rotation.z = -markerRotation.z;
                
                // Ãp dá»¥ng rotation Y tá»« tÆ°Æ¡ng tÃ¡c ngÆ°á»i dÃ¹ng
                rig.object3D.rotation.y = userRotationY;
            }
            requestAnimationFrame(autoLeveling);
        }
        autoLeveling();

        // --- TÆ¯Æ NG TÃC (XOAY VÃ€ ZOOM) ---
        let touchStartPos = 0;
        let touchStartDist = 0;

        window.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                touchStartPos = e.touches[0].pageX;
            } else if (e.touches.length === 2) {
                touchStartDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            }
        });

        window.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1) {
                let delta = e.touches[0].pageX - touchStartPos;
                userRotationY += delta * 0.01;
                touchStartPos = e.touches[0].pageX;
            } else if (e.touches.length === 2) {
                let dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                let factor = dist / touchStartDist;
                userScale = Math.min(Math.max(userScale * factor, 0.5), 2);
                rig.setAttribute('scale', `${userScale} ${userScale} ${userScale}`);
                touchStartDist = dist;
            }
        });

        // --- Ká»ŠCH Báº¢N THÃ NGHIá»†M ---
        async function handleAction() {
            mainBtn.disabled = true;

            if (currentStep === 0) {
                // BÆ°á»›c 1: Nhá» Iodine
                statusText.textContent = "Äang nhá» dung dá»‹ch Iodine vÃ o há»“ tinh bá»™t...";
                
                // Di chuyá»ƒn pipette
                pipette.setAttribute('animation', { property: 'position', to: '0 3.5 0', dur: 1000 });
                pipette.setAttribute('animation__2', { property: 'rotation', to: '0 0 0', dur: 800 });
                
                await new Promise(r => setTimeout(r, 1200));
                
                const drop = document.querySelector('#iodine-drop');
                drop.setAttribute('visible', 'true');
                drop.setAttribute('position', '0 2 0');
                drop.setAttribute('animation', { property: 'position', to: '0 0.8 0', dur: 600 });
                
                await new Promise(r => setTimeout(r, 600));
                drop.setAttribute('visible', 'false');
                
                // Äá»•i mÃ u sang xanh tÃ­m
                liquid.setAttribute('animation', { property: 'material.color', to: '#1a237e', dur: 1500 });
                liquidSurface.setAttribute('animation', { property: 'material.color', to: '#1a237e', dur: 1500 });
                
                await new Promise(r => setTimeout(r, 1500));
                statusText.textContent = "Há»“ tinh bá»™t Ä‘Ã£ chuyá»ƒn sang mÃ u xanh tÃ­m!";
                mainBtn.textContent = "NhÃºng vÃ o nÆ°á»›c nÃ³ng";
                currentStep = 1;
            } 
            else if (currentStep === 1) {
                // BÆ°á»›c 2: NÆ°á»›c nÃ³ng
                statusText.textContent = "Äang nhÃºng vÃ o cá»‘c nÆ°á»›c nÃ³ng (70Â°C)...";
                beaker.setAttribute('visible', 'true');
                beakerLiquid.setAttribute('material', 'color', '#ff4b2b');
                beakerLabel.setAttribute('value', 'NÆ¯á»šC NÃ“NG');
                
                // Di chuyá»ƒn á»‘ng nghiá»‡m vÃ o cá»‘c
                document.querySelector('#test-tube-container').setAttribute('animation', {
                    property: 'position', to: '-1.8 1.5 0', dur: 1500
                });
                
                await new Promise(r => setTimeout(r, 2000));
                
                // Máº¥t mÃ u
                liquid.setAttribute('animation', { property: 'material.color', to: '#ffffff', dur: 2000 });
                liquidSurface.setAttribute('animation', { property: 'material.color', to: '#ffffff', dur: 2000 });
                
                await new Promise(r => setTimeout(r, 2000));
                statusText.textContent = "Nhiá»‡t Ä‘á»™ cao lÃ m cÃ¡c phÃ¢n tá»­ Iodine rá»i khá»i máº¡ch tinh bá»™t. MÃ u biáº¿n máº¥t.";
                mainBtn.textContent = "NhÃºng vÃ o nÆ°á»›c láº¡nh";
                currentStep = 2;
            }
            else if (currentStep === 2) {
                // BÆ°á»›c 3: NÆ°á»›c láº¡nh
                statusText.textContent = "Äang nhÃºng vÃ o cá»‘c nÆ°á»›c láº¡nh (10Â°C)...";
                beakerLiquid.setAttribute('material', 'color', '#4facfe');
                beakerLabel.setAttribute('value', 'NÆ¯á»šC Láº NH');
                
                await new Promise(r => setTimeout(r, 1000));
                
                // Xuáº¥t hiá»‡n mÃ u láº¡i
                liquid.setAttribute('animation', { property: 'material.color', to: '#1a237e', dur: 2000 });
                liquidSurface.setAttribute('animation', { property: 'material.color', to: '#1a237e', dur: 2000 });
                
                await new Promise(r => setTimeout(r, 2000));
                statusText.textContent = "Nhiá»‡t Ä‘á»™ tháº¥p giÃºp Iodine tÃ¡i háº¥p phá»¥. MÃ u xanh tÃ­m xuáº¥t hiá»‡n trá»Ÿ láº¡i!";
                mainBtn.textContent = "LÃ m láº¡i thÃ­ nghiá»‡m";
                currentStep = 3;
            } else {
                location.reload();
            }

            mainBtn.disabled = false;
        }

        marker.addEventListener('markerFound', () => { statusText.textContent = "Há»‡ thá»‘ng Ä‘Ã£ nháº­n diá»‡n. Sáºµn sÃ ng!"; });
    </script>
</body>
</html>
