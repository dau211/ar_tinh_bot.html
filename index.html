<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>AR Floating Lab - H·ªì Tinh B·ªôt & Iodine</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #000; }
        
        #status-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            z-index: 100;
            pointer-events: none;
        }

        .status-bar {
            background: rgba(0, 10, 20, 0.85);
            backdrop-filter: blur(15px);
            border-left: 4px solid #00f2fe;
            border-radius: 12px;
            padding: 15px 25px;
            text-align: left;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        h2 { margin: 0; font-size: 13px; color: #00f2fe; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.8; }
        p { margin: 6px 0 0 0; font-size: 16px; color: #ffffff; font-weight: 600; line-height: 1.4; }

        #action-container {
            position: absolute;
            bottom: 40px;
            right: 40px;
            z-index: 100;
        }

        button {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            border: none;
            padding: 18px 36px;
            border-radius: 15px;
            color: #0a192f;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase;
            font-size: 14px;
            box-shadow: 0 10px 25px rgba(0, 242, 254, 0.4);
            pointer-events: auto;
        }

        button:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0, 242, 254, 0.5); }
        button:active { transform: scale(0.95); }
        button:disabled { background: #2c3e50; color: #7f8c8d; cursor: not-allowed; box-shadow: none; }

        #mini-guide {
            position: absolute;
            bottom: 30px;
            left: 30px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            z-index: 100;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="status-container">
        <div class="status-bar">
            <h2 id="step-title">Ph√≤ng Th√≠ Nghi·ªám H√≥a H·ªçc 3D</h2>
            <p id="status-text">ƒêang kh·ªüi t·∫°o m√¥i tr∆∞·ªùng AR...</p>
        </div>
    </div>

    <div id="mini-guide">
        üß™ Marker: HIRO | üñê Xoay d·ª•ng c·ª• | üîé Thu ph√≥ng
    </div>

    <div id="action-container">
        <button id="main-btn" onclick="handleAction()">B·∫Øt ƒë·∫ßu</button>
    </div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false;" 
        renderer="antialias: true; colorManagement: true; exposure: 1.2; shadowMapEnabled: true;"
        vr-mode-ui="enabled: false">

        <a-assets>
            <!-- V·∫≠t li·ªáu th·ªßy tinh ch√¢n th·ª±c h∆°n v·ªõi ƒë·ªô b√≥ng v√† ph·∫£n x·∫° -->
            <a-mixin id="glass-3d" material="color: #e3f2fd; opacity: 0.3; transparent: true; metalness: 0.6; roughness: 0.1; envMapIntensity: 1; side: double"></a-mixin>
            <a-mixin id="liquid-starch" material="color: #f8f9fa; opacity: 0.9; roughness: 0.8; metalness: 0"></a-mixin>
            <a-mixin id="liquid-iodine" material="color: #7b241c; opacity: 1; roughness: 0.3; metalness: 0.1"></a-mixin>
            <a-mixin id="label-text" text="align: center; color: #ffffff; width: 3; font: https://cdn.aframe.io/fonts/Aileron-Semibold.fnt; wrapCount: 20"></a-mixin>
        </a-assets>

        <a-marker preset="hiro" id="marker">
            <a-entity id="zoom-rig" scale="1 1 1">
                <a-entity id="rig">
                    
                    <!-- 1. ·ªêNG NGHI·ªÜM H√åNH TR·ª§ CH√ÇN TH·ª∞C (Starch) -->
                    <a-entity id="test-tube-container" position="0 1.2 0.5">
                        <a-text mixin="label-text" value="H·ªì Tinh B·ªôt" position="0 2 0.4" color="#00f2fe"></a-text>
                        
                        <a-entity id="tube-body">
                            <!-- Th√¢n ·ªëng nghi·ªám v·ªõi v√†nh mi·ªáng -->
                            <a-cylinder height="3.2" radius="0.32" mixin="glass-3d" open-ended="false"></a-cylinder>
                            <a-torus radius="0.32" radius-tubular="0.02" rotation="90 0 0" position="0 1.6 0" mixin="glass-3d"></a-torus>
                            <!-- ƒê√°y ·ªëng nghi·ªám d·∫°ng c·∫ßu -->
                            <a-sphere position="0 -1.6 0" radius="0.32" theta-length="90" rotation="180 0 0" mixin="glass-3d"></a-sphere>
                            
                            <!-- Dung d·ªãch b√™n trong -->
                            <a-entity id="liquid-group">
                                <a-cylinder id="liquid" height="0.01" radius="0.31" position="0 -1.6 0" mixin="liquid-starch"></a-cylinder>
                                <a-circle id="liquid-surface" radius="0.31" position="0 -1.6 0" rotation="-90 0 0" mixin="liquid-starch"></a-circle>
                            </a-entity>
                        </a-entity>
                    </a-entity>

                    <!-- 2. L·ªå IODINE & ·ªêNG H√öT (Pipette) -->
                    <a-entity id="iodine-system" position="2.2 0.8 0.5">
                        <a-text mixin="label-text" value="Dung d·ªãch I2" position="0 1.5 0.5" color="#e67e22"></a-text>
                        <!-- L·ªç ƒë·ª±ng Iodine -->
                        <a-cylinder height="1.8" radius="0.5" mixin="glass-3d" material="color: #3e2723; opacity: 0.6"></a-cylinder>
                        <a-cylinder height="1.6" radius="0.48" position="0 0 0" material="color: #4e342e; opacity: 0.95"></a-cylinder>
                        
                        <!-- ·ªêng h√∫t (Pipette) chi ti·∫øt -->
                        <a-entity id="pipette" position="0 1.4 0" rotation="0 0 -15">
                            <a-sphere radius="0.14" scale="1 1.6 1" position="0 1.1 0" material="color: #cc0000; roughness: 0.5"></a-sphere> <!-- B√≥p cao su -->
                            <a-cylinder height="2.2" radius="0.03" mixin="glass-3d"></a-cylinder> <!-- Th√¢n ·ªëng th·ªßy tinh -->
                            <a-cylinder id="pipette-liquid" height="0.8" radius="0.025" position="0 -0.4 0" material="color: #7b241c"></a-cylinder> <!-- Iodine trong ·ªëng -->
                            <a-cone height="0.35" radius-bottom="0.03" radius-top="0.005" position="0 -1.25 0" mixin="glass-3d"></a-cone> <!-- ƒê·∫ßu nh·ªçn -->
                        </a-entity>
                    </a-entity>

                    <!-- 3. C·ªêC TH·ª¶Y TINH N∆Ø·ªöC N√ìNG (Beaker) -->
                    <a-entity id="hot-beaker" position="-2.2 0.8 0.5">
                        <a-text mixin="label-text" value="N∆∞·ªõc N√≥ng" position="0 1.8 1" color="#ff4d4d"></a-text>
                        <a-cylinder height="2.5" radius="1" mixin="glass-3d" open-ended="true"></a-cylinder>
                        <a-cylinder height="0.05" radius="1" position="0 -1.25 0" mixin="glass-3d"></a-cylinder>
                        <!-- V√†nh c·ªëc -->
                        <a-torus radius="1" radius-tubular="0.02" rotation="90 0 0" position="0 1.25 0" mixin="glass-3d"></a-torus>
                        <a-cylinder height="1.8" radius="0.98" position="0 -0.3 0" material="color: #ff3333; opacity: 0.35; transparent: true"></a-cylinder>
                    </a-entity>

                    <!-- 4. C·ªêC TH·ª¶Y TINH N∆Ø·ªöC L·∫†NH (Beaker) -->
                    <a-entity id="cold-beaker" position="-4.5 0.8 0.5">
                        <a-text mixin="label-text" value="N∆∞·ªõc L·∫°nh" position="0 1.8 1" color="#33ccff"></a-text>
                        <a-cylinder height="2.5" radius="1" mixin="glass-3d" open-ended="true"></a-cylinder>
                        <a-cylinder height="0.05" radius="1" position="0 -1.25 0" mixin="glass-3d"></a-cylinder>
                        <a-torus radius="1" radius-tubular="0.02" rotation="90 0 0" position="0 1.25 0" mixin="glass-3d"></a-torus>
                        <a-cylinder height="1.8" radius="0.98" position="0 -0.3 0" material="color: #0066ff; opacity: 0.35; transparent: true"></a-cylinder>
                    </a-entity>

                    <!-- Gi·ªçt b·∫Øn Iodine -->
                    <a-sphere id="iodine-drop" radius="0.04" material="color: #7b241c" visible="false"></a-sphere>

                    <!-- H·ªá th·ªëng √°nh s√°ng Studio -->
                    <a-entity light="type: ambient; intensity: 0.7"></a-entity>
                    <a-entity light="type: directional; intensity: 1.2; castShadow: true" position="2 4 4"></a-entity>
                    <a-entity light="type: point; intensity: 0.5; distance: 5" position="-2 2 2"></a-entity>
                </a-entity>
            </a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const marker = document.querySelector('#marker');
        const rig = document.querySelector('#rig');
        const zoomRig = document.querySelector('#zoom-rig');
        const liquid = document.querySelector('#liquid');
        const liquidSurface = document.querySelector('#liquid-surface');
        const pipette = document.querySelector('#pipette');
        const testTubeContainer = document.querySelector('#test-tube-container');
        const statusText = document.querySelector('#status-text');
        const mainBtn = document.querySelector('#main-btn');

        let currentStep = 0;
        let userRotationY = 0;
        let currentScale = 1;

        // M√†u s·∫Øc ƒë√∫ng b·∫£n ch·∫•t h√≥a h·ªçc
        const COLOR_STARCH = "#f8f9fa"; // Tr·∫Øng ƒë·ª•c c·ªßa h·ªì tinh b·ªôt
        const COLOR_IODINE = "#7b241c"; // N√¢u ƒë·ªè h·ªï ph√°ch c·ªßa dung d·ªãch I2/KI
        const COLOR_COMPLEX = "#0a0a3a"; // Xanh t√≠m c·ª±c ƒë·∫≠m (g·∫ßn nh∆∞ ƒëen) c·ªßa ph·ª©c tinh b·ªôt-iodine

        function autoLeveling() {
            if (marker.object3D.visible) {
                const markerRotation = marker.object3D.rotation;
                rig.object3D.rotation.x = -markerRotation.x;
                rig.object3D.rotation.z = -markerRotation.z;
                rig.object3D.rotation.y = userRotationY;
            }
            requestAnimationFrame(autoLeveling);
        }
        autoLeveling();

        // X·ª≠ l√Ω c·ª≠ ch·ªâ
        let touchX = 0;
        let initialDist = 0;

        window.addEventListener('touchstart', e => {
            if (e.touches.length === 1) touchX = e.touches[0].pageX;
            if (e.touches.length === 2) {
                initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            }
        });

        window.addEventListener('touchmove', e => {
            if (e.touches.length === 1) {
                let delta = e.touches[0].pageX - touchX;
                userRotationY += delta * 0.01;
                touchX = e.touches[0].pageX;
            }
            if (e.touches.length === 2) {
                let dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                let diff = dist - initialDist;
                currentScale = Math.max(0.4, Math.min(2.5, currentScale + diff * 0.005));
                zoomRig.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
                initialDist = dist;
            }
        });

        window.addEventListener('wheel', e => {
            currentScale = Math.max(0.4, Math.min(2.5, currentScale - e.deltaY * 0.001));
            zoomRig.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
        });

        async function handleAction() {
            mainBtn.disabled = true;

            if (currentStep === 0) {
                statusText.textContent = "Chu·∫©n b·ªã m·∫´u: R√≥t h·ªì tinh b·ªôt tr·∫Øng ƒë·ª•c v√†o ·ªëng nghi·ªám...";
                liquid.setAttribute('animation', { property: 'height', to: 1.6, dur: 2500, easing: 'easeOutQuad' });
                liquid.setAttribute('animation__pos', { property: 'position', to: '0 -0.8 0', dur: 2500, easing: 'easeOutQuad' });
                liquidSurface.setAttribute('animation', { property: 'position', to: '0 0 0', dur: 2500, easing: 'easeOutQuad' });
                
                await new Promise(r => setTimeout(r, 2600));
                statusText.textContent = "H·ªì tinh b·ªôt ƒë√£ s·∫µn s√†ng. H√£y nh·ªè Iodine.";
                mainBtn.textContent = "Nh·ªè Iodine";
                currentStep = 1;
            } 
            else if (currentStep === 1) {
                statusText.textContent = "Nh·ªè Iodine (n√¢u ƒë·ªè) v√†o tinh b·ªôt...";
                // Di chuy·ªÉn pipette ƒë·∫øn ·ªëng nghi·ªám
                pipette.setAttribute('animation', { property: 'position', to: '-2.2 1.6 0', dur: 1200, easing: 'easeInOutQuad' });
                pipette.setAttribute('animation__2', { property: 'rotation', to: '0 0 0', dur: 1000 });
                
                await new Promise(r => setTimeout(r, 1300));
                
                // Nh·ªè gi·ªçt
                const drop = document.querySelector('#iodine-drop');
                drop.setAttribute('visible', 'true');
                drop.setAttribute('position', '0 1.5 0.5');
                drop.setAttribute('animation', { property: 'position', to: '0 0.6 0.5', dur: 700, easing: 'easeInQuad' });
                
                await new Promise(r => setTimeout(r, 750));
                drop.setAttribute('visible', 'false');
                
                // L·∫Øc v√† chuy·ªÉn m√†u xanh t√≠m ƒë·∫≠m
                document.querySelector('#tube-body').setAttribute('animation', {
                    property: 'rotation', to: '0 0 8', dur: 150, dir: 'alternate', loop: 8
                });
                
                liquid.setAttribute('animation', { property: 'material.color', to: COLOR_COMPLEX, dur: 1500 });
                liquidSurface.setAttribute('animation', { property: 'material.color', to: COLOR_COMPLEX, dur: 1500 });
                
                await new Promise(r => setTimeout(r, 1600));
                statusText.textContent = "Hi·ªán t∆∞·ª£ng: H√¨nh th√†nh ph·ª©c xanh t√≠m ƒë·∫≠m ƒë·∫∑c tr∆∞ng.";
                mainBtn.textContent = "ƒêun N√≥ng (C·ªëc ƒê·ªè)";
                currentStep = 2;
            }
            else if (currentStep === 2) {
                statusText.textContent = "ƒêun n√≥ng: C√°c ph√¢n t·ª≠ I2 tho√°t kh·ªèi c·∫•u tr√∫c l√≤ xo c·ªßa tinh b·ªôt...";
                
                // N√¢ng ·ªëng nghi·ªám l√™n v√† ƒë∆∞a v√†o c·ªëc n∆∞·ªõc n√≥ng
                testTubeContainer.setAttribute('animation', { property: 'position', to: '0 3.0 0.5', dur: 800, easing: 'easeOutQuad' });
                await new Promise(r => setTimeout(r, 900));
                
                testTubeContainer.setAttribute('animation', { property: 'position', to: '-2.2 3.0 0.5', dur: 1000 });
                await new Promise(r => setTimeout(r, 1100));
                
                testTubeContainer.setAttribute('animation', { property: 'position', to: '-2.2 0.8 0.5', dur: 800, easing: 'easeInQuad' });
                await new Promise(r => setTimeout(r, 900));
                
                // M·∫•t m√†u (chuy·ªÉn v·ªÅ tr·∫Øng ƒë·ª•c)
                liquid.setAttribute('animation', { property: 'material.color', to: COLOR_STARCH, dur: 5000 });
                liquidSurface.setAttribute('animation', { property: 'material.color', to: COLOR_STARCH, dur: 5000 });
                
                await new Promise(r => setTimeout(r, 5200));
                statusText.textContent = "K·∫øt qu·∫£: Ph·ª©c tan, dung d·ªãch tr·ªü l·∫°i m√†u tr·∫Øng ƒë·ª•c.";
                mainBtn.textContent = "L√†m L·∫°nh (C·ªëc Xanh)";
                currentStep = 3;
            }
            else if (currentStep === 3) {
                statusText.textContent = "L√†m l·∫°nh: I2 h·∫•p ph·ª• tr·ªü l·∫°i v√†o c·∫•u tr√∫c tinh b·ªôt...";
                
                testTubeContainer.setAttribute('animation', { property: 'position', to: '-2.2 3.0 0.5', dur: 800, easing: 'easeOutQuad' });
                await new Promise(r => setTimeout(r, 900));
                
                testTubeContainer.setAttribute('animation', { property: 'position', to: '-4.5 3.0 0.5', dur: 1200 });
                await new Promise(r => setTimeout(r, 1300));
                
                testTubeContainer.setAttribute('animation', { property: 'position', to: '-4.5 0.8 0.5', dur: 800, easing: 'easeInQuad' });
                await new Promise(r => setTimeout(r, 900));
                
                // Hi·ªán m√†u xanh t√≠m tr·ªü l·∫°i
                liquid.setAttribute('animation', { property: 'material.color', to: COLOR_COMPLEX, dur: 3500 });
                liquidSurface.setAttribute('animation', { property: 'material.color', to: COLOR_COMPLEX, dur: 3500 });
                
                await new Promise(r => setTimeout(r, 3700));
                statusText.textContent = "K·∫øt qu·∫£: M√†u xanh t√≠m ƒë·∫≠m xu·∫•t hi·ªán tr·ªü l·∫°i.";
                mainBtn.textContent = "Kh·ªüi ƒë·ªông l·∫°i";
                currentStep = 4;
            } else {
                location.reload();
            }

            mainBtn.disabled = false;
        }

        marker.addEventListener('markerFound', () => { 
            statusText.textContent = "ƒê√£ t√¨m th·∫•y Marker. H√£y ch·∫°m 'B·∫Øt ƒë·∫ßu'!"; 
        });
        marker.addEventListener('markerLost', () => {
            statusText.textContent = "Vui l√≤ng h∆∞·ªõng camera v√†o Marker HIRO.";
        });
    </script>
</body>
</html>
